<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BigQuery Q&A Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #chat-box::-webkit-scrollbar {
            width: 8px;
        }
        #chat-box::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #chat-box::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #chat-box::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .dot-flashing {
            position: relative;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-flashing 1s infinite linear alternate;
            animation-delay: .5s;
        }
        .dot-flashing::before, .dot-flashing::after {
            content: '';
            display: inline-block;
            position: absolute;
            top: 0;
        }
        .dot-flashing::before {
            left: -10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 0s;
        }
        .dot-flashing::after {
            left: 10px;
            width: 6px;
            height: 6px;
            border-radius: 5px;
            background-color: #9880ff;
            color: #9880ff;
            animation: dot-flashing 1s infinite alternate;
            animation-delay: 1s;
        }
        @keyframes dot-flashing {
            0% { background-color: #a7a7a7; }
            50%, 100% { background-color: #6b6b6b; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex flex-col h-screen bg-white">
        <header class="bg-blue-600 text-white p-4 text-center shadow-md z-10">
            <h1 class="text-2xl font-bold">BigQuery Q&A Assistant</h1>
        </header>
        
        <div class="bg-gray-50 p-3 border-b">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm max-w-4xl mx-auto">
                <div>
                    <label for="project_id" class="block text-xs font-medium text-gray-600">Project ID</label>
                    <input type="text" id="project_id" name="project_id" class="w-full px-3 py-1 mt-1 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition" value="eikon-dev-data-team" required>
                </div>
                <div>
                    <label for="dataset_id" class="block text-xs font-medium text-gray-600">Dataset ID</label>
                    <input type="text" id="dataset_id" name="dataset_id" class="w-full px-3 py-1 mt-1 border border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition" value="ancoldbdufanlive" required>
                </div>
            </div>
        </div>

        <main id="chat-box" class="flex-1 p-6 overflow-y-auto bg-gray-100">
            <div class="max-w-4xl mx-auto w-full">
                 <!-- Chat messages will be appended here -->
            </div>
        </main>

        <footer class="p-4 bg-white border-t">
            <div class="max-w-4xl mx-auto">
                <div id="error-message" class="hidden mb-2 bg-red-100 border border-red-300 text-red-700 px-4 py-2 rounded-lg text-sm" role="alert">
                    <p id="error-text"></p>
                </div>
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="text" id="chat-input" class="flex-1 w-full px-4 py-2 border border-gray-300 rounded-full focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ask a question about the data..." autocomplete="off" required>
                    <button type="submit" class="bg-blue-600 text-white font-bold p-2 rounded-full hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                        </svg>
                    </button>
                </form>
            </div>
        </footer>
    </div>

    <div id="fullscreen-modal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center p-4 hidden z-50 cursor-pointer">
        <img id="fullscreen-img" src="" alt="Fullscreen Chart" class="max-w-full max-h-full object-contain">
        <button id="close-modal-btn" class="absolute top-5 right-8 text-white text-5xl font-bold">&times;</button>
    </div>

    <script>
        // --- DOM Element References ---
        const chatBox = document.getElementById('chat-box').querySelector('.max-w-4xl');
        const chatBoxContainer = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const projectIdInput = document.getElementById('project_id');
        const datasetIdInput = document.getElementById('dataset_id');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const fullscreenModal = document.getElementById('fullscreen-modal');
        const fullscreenImg = document.getElementById('fullscreen-img');
        const closeModalBtn = document.getElementById('close-modal-btn');

        // --- State Management ---
        let threadId = null;
        let chatHistory = [];
        const API_BASE_URL = 'https://bigquery-nl2sql-158103152291.asia-southeast2.run.app';

        // --- Helper Functions ---
        function scrollToBottom() {
            chatBoxContainer.scrollTop = chatBoxContainer.scrollHeight;
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }
        
        function displayMessage(content, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = 'mb-4 flex';

            const messageBubble = document.createElement('div');
            messageBubble.className = 'max-w-xl p-3 rounded-lg shadow';
            
            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageBubble.classList.add('bg-blue-500', 'text-white');
                messageBubble.textContent = content;
            } else {
                messageWrapper.classList.add('justify-start');
                messageBubble.classList.add('bg-gray-200', 'text-gray-800');
                messageBubble.innerHTML = content;
            }
            
            messageWrapper.appendChild(messageBubble);
            chatBox.appendChild(messageWrapper);
            scrollToBottom();
            return messageBubble;
        }

        function showThinkingIndicator() {
            const indicatorHTML = `<div class="flex items-center justify-center p-2"><div class="dot-flashing"></div></div>`;
            return displayMessage(indicatorHTML, 'bot');
        }

        // --- Event Listeners ---
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const question = chatInput.value.trim();
            if (!question) return;

            hideError();
            displayMessage(question, 'user');
            chatHistory.push({ role: 'user', content: question });
            chatInput.value = '';
            const thinkingIndicator = showThinkingIndicator();

            const requestData = {
                project_id: projectIdInput.value,
                dataset_id: datasetIdInput.value,
                question: question,
                chat_history: chatHistory.slice(0, -1)
            };

            try {
                const response = await fetch(`${API_BASE_URL}/generate-query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    chatHistory.pop();
                    throw new Error(errorData.detail || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                threadId = data.thread_id;
                
                thinkingIndicator.parentElement.remove();
                displayApprovalMessage(data.query);

            } catch (error) {
                thinkingIndicator.parentElement.remove();
                displayMessage(`Sorry, I ran into an error: ${error.message}`, 'bot');
                showError(`Failed to generate query: ${error.message}`);
            }
        });

        function displayApprovalMessage(query) {
            const approvalHTML = `
                <p class="mb-2 font-medium">Here is the generated SQL query. Please review it.</p>
                <textarea id="sql-query-textarea" class="w-full p-2 font-mono text-sm bg-gray-50 border border-gray-300 rounded-md h-32 resize-y">${query}</textarea>
                <div class="flex justify-end items-center gap-2 mt-2">
                    <button id="deny-btn" class="px-4 py-1 text-sm bg-red-500 text-white font-semibold rounded-md hover:bg-red-600 transition-all">Deny</button>
                    <button id="approve-btn" class="px-4 py-1 text-sm bg-green-500 text-white font-semibold rounded-md hover:bg-green-600 transition-all">Approve & Run</button>
                </div>
            `;
            const messageBubble = displayMessage(approvalHTML, 'bot');

            messageBubble.querySelector('#deny-btn').addEventListener('click', () => {
                chatHistory.pop();
                messageBubble.innerHTML = `<p class="text-gray-500 italic">Operation cancelled by user.</p>`;
            });

            messageBubble.querySelector('#approve-btn').addEventListener('click', handleApproval);
        }

        async function handleApproval() {
            if (!threadId) {
                showError("Session expired or invalid. Please start over.");
                return;
            }

            const thinkingIndicator = showThinkingIndicator();
            const sqlTextarea = document.getElementById('sql-query-textarea');
            const executedQuery = sqlTextarea.value;

            const approveBtn = document.getElementById('approve-btn');
            const denyBtn = document.getElementById('deny-btn');
            if(approveBtn && denyBtn) {
                approveBtn.disabled = true;
                denyBtn.disabled = true;
                approveBtn.classList.add('opacity-50');
                denyBtn.classList.add('opacity-50');
            }

            const requestData = {
                thread_id: threadId,
                approved: true,
                query: executedQuery,
                project_id: projectIdInput.value,
                dataset_id: datasetIdInput.value,
            };

            try {
                const response = await fetch(`${API_BASE_URL}/execute-query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                thinkingIndicator.parentElement.remove();
                displayResults(data, executedQuery);

                const botResponseSummary = `Generated SQL: ${executedQuery}. Final Answer: ${data.answer || 'N/A'}. Insight: ${data.insight || 'N/A'}`;
                chatHistory.push({ role: 'assistant', content: botResponseSummary });

            } catch (error) {
                thinkingIndicator.parentElement.remove();
                displayMessage(`Sorry, I ran into an error while executing the query: ${error.message}`, 'bot');
                showError(`Failed to execute query: ${error.message}`);
                chatHistory.pop();
            }
        }

        function displayResults(data, executedQuery) {
            if (data.answer) {
                displayMessage(`<strong class="font-semibold block mb-1">Final Answer:</strong>${data.answer}`, 'bot');
            }
            if (data.insight) {
                displayMessage(`<strong class="font-semibold block mb-1">Data Insight:</strong>${data.insight}`, 'bot');
            }
            
            // PERUBAHAN DI SINI: Menambahkan tombol Hide/Show untuk SQL
            const sqlId = `sql-${Date.now()}`;
            const sqlHTML = `
                <div class="flex justify-between items-center mb-1">
                    <strong class="font-semibold">Executed SQL:</strong>
                    <button data-sql-id="${sqlId}" class="toggle-sql-btn text-xs text-blue-600 hover:underline">Hide</button>
                </div>
                <pre id="${sqlId}" class="bg-gray-100 p-2 rounded mt-1 font-mono text-xs overflow-x-auto"><code>${executedQuery}</code></pre>
            `;
            displayMessage(sqlHTML, 'bot');
            // AKHIR PERUBAHAN

            if (data.chart_png_base64) {
                const chartId = `chart-${Date.now()}`;
                const chartHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <strong class="font-semibold">Chart:</strong>
                        <button data-chart-id="${chartId}" class="show-fullscreen-btn text-xs text-blue-600 hover:underline">Lihat Layar Penuh</button>
                    </div>
                    <img id="${chartId}" src="data:image/png;base64,${data.chart_png_base64}" alt="Generated Chart" class="w-full h-auto rounded-md border">
                `;
                displayMessage(chartHTML, 'bot');
            }

            if (data.raw_result && data.raw_result.length > 0) {
                let tableHTML = '<strong class="font-semibold block mb-2">Raw Data:</strong><div class="overflow-x-auto border rounded-lg shadow-sm"><table class="min-w-full divide-y divide-gray-200 text-sm">';
                
                tableHTML += '<thead class="bg-gray-50"><tr class="text-left">';
                Object.keys(data.raw_result[0]).forEach(key => {
                    tableHTML += `<th class="px-4 py-2 font-medium text-gray-600 uppercase tracking-wider">${key}</th>`;
                });
                tableHTML += '</tr></thead>';

                tableHTML += '<tbody class="bg-white divide-y divide-gray-200">';
                data.raw_result.forEach(rowData => {
                    tableHTML += '<tr>';
                    Object.values(rowData).forEach(value => {
                        tableHTML += `<td class="px-4 py-2 whitespace-nowrap">${value}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                tableHTML += '</tbody></table></div>';
                displayMessage(tableHTML, 'bot');
            } else {
                 displayMessage(`<strong class="font-semibold block mb-1">Raw Data:</strong><p class="text-gray-500 italic">No raw data returned.</p>`, 'bot');
            }
        }
        
        chatBox.addEventListener('click', (e) => {
            if (e.target) {
                // Menangani tombol fullscreen chart
                if (e.target.classList.contains('show-fullscreen-btn')) {
                    const chartId = e.target.dataset.chartId;
                    const chartImg = document.getElementById(chartId);
                    if (chartImg) {
                        fullscreenImg.src = chartImg.src;
                        fullscreenModal.classList.remove('hidden');
                    }
                }

                // PERUBAHAN DI SINI: Menangani tombol toggle SQL
                if (e.target.classList.contains('toggle-sql-btn')) {
                    const sqlId = e.target.dataset.sqlId;
                    const preElement = document.getElementById(sqlId);
                    if (preElement) {
                        const isHidden = preElement.classList.toggle('hidden');
                        e.target.textContent = isHidden ? 'Show' : 'Hide';
                    }
                }
                // AKHIR PERUBAHAN
            }
        });

        function closeModal() {
            fullscreenModal.classList.add('hidden');
            fullscreenImg.src = '';
        }

        closeModalBtn.addEventListener('click', closeModal);
        fullscreenModal.addEventListener('click', (e) => {
            if (e.target === fullscreenModal) {
                closeModal();
            }
        });

        window.addEventListener('load', () => {
            displayMessage('Hello! How can I help you analyze the BigQuery data today?', 'bot');
        });

    </script>
</body>
</html>